# TigerVNC multi-stage image with ros2_control stack
ARG ROS_DISTRO=jazzy

# Stage 1: base TigerVNC/noVNC desktop
FROM ghcr.io/ipa-may/ros2-tigervnc-novnc:${ROS_DISTRO}-vscode-xfce AS tigervnc-base
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update -q && \
    apt-get install -y --no-install-recommends \
      nano \
      vim \
      libi2c-dev && \
    rm -rf /var/lib/apt/lists/*

# Stage 2: install ros2_control stack separately
FROM ros:${ROS_DISTRO}-ros-base AS ros2-control-builder
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update -q && \
    apt-get install -y --no-install-recommends \
      build-essential \
      python3-colcon-common-extensions \
      ros-${ROS_DISTRO}-ros2-control \
      ros-${ROS_DISTRO}-ros2-controllers \
      ros-${ROS_DISTRO}-hardware-interface \
      ros-${ROS_DISTRO}-hardware-interface-testing \
      ros-${ROS_DISTRO}-controller-manager \
      ros-${ROS_DISTRO}-velocity-controllers \
      ros-${ROS_DISTRO}-joint-state-broadcaster \
      ros-${ROS_DISTRO}-robot-state-publisher \
      ros-${ROS_DISTRO}-joint-state-publisher-gui \
      ros-${ROS_DISTRO}-xacro \
      ros-${ROS_DISTRO}-tf2 \
      ros-${ROS_DISTRO}-tf2-msgs \
      ros-${ROS_DISTRO}-rviz2 \
      ros-${ROS_DISTRO}-ur \
      ros-${ROS_DISTRO}-moveit \
      ros-${ROS_DISTRO}-octomap \
      ros-${ROS_DISTRO}-plotjuggler-ros && \
    rm -rf /var/lib/apt/lists/*

# Stage 3: runtime inherits TigerVNC stack
FROM tigervnc-base AS runtime
ENV DEBIAN_FRONTEND=noninteractive

# Align container user/group with host IDs when provided
ARG USERNAME=ros
ARG USER_ID=1001
ARG GROUP_ID=$USER_ID

RUN EXISTING_GROUP=$(getent group "$GROUP_ID" | cut -d: -f1 || true) \
 && if [ -n "$EXISTING_GROUP" ]; then \
      echo "Using existing group $EXISTING_GROUP (gid $GROUP_ID)"; \
      GROUP_NAME=$EXISTING_GROUP; \
    elif getent group "$USERNAME" >/dev/null 2>&1; then \
      groupmod --gid "$GROUP_ID" "$USERNAME"; \
      GROUP_NAME=$USERNAME; \
    else \
      groupadd --gid "$GROUP_ID" "$USERNAME"; \
      GROUP_NAME=$USERNAME; \
    fi \
 && EXISTING_USER=$(getent passwd "$USER_ID" | cut -d: -f1 || true) \
 && if [ -n "$EXISTING_USER" ]; then \
      echo "Reusing user $EXISTING_USER (uid $USER_ID)"; \
      usermod --login "$USERNAME" --home /home/"$USERNAME" --move-home "$EXISTING_USER"; \
      USER_NAME=$USERNAME; \
    elif id -u "$USERNAME" >/dev/null 2>&1; then \
      usermod --uid "$USER_ID" --gid "$GROUP_ID" "$USERNAME"; \
      USER_NAME=$USERNAME; \
    else \
      useradd -s /bin/bash --uid "$USER_ID" --gid "$GROUP_ID" -m "$USERNAME"; \
      USER_NAME=$USERNAME; \
    fi \
 && mkdir -p /home/"$USERNAME"/.config \
 && chown "$USER_ID":"$GROUP_ID" /home/"$USERNAME"/.config

# Copy ros2_control stack into runtime ROS tree
COPY --from=ros2-control-builder /opt/ros/${ROS_DISTRO} /opt/ros/${ROS_DISTRO}

# Provide colcon argcomplete/extension hooks expected by sourced environments
RUN apt-get update -q && \
    apt-get install -y --no-install-recommends \
      python3-colcon-common-extensions \
      python3-colcon-argcomplete \
      python3-catkin-pkg \
      python3-catkin-pkg-modules \
      libqt5x11extras5 \
      liboctomap1.9 \
      python3-filelock \
      liblua5.1-0 \
      libfcl0.7 && \
    rm -rf /var/lib/apt/lists/*

# Ensure the Python ament/CMake finds (/usr/local/python/current/bin/python3)
# can import catkin_pkg; copy the apt-installed module into its site-packages.
RUN set -e; \
    SYS_SITE=$(/usr/bin/python3 - <<'PY' \
import site; \
print([p for p in site.getsitepackages() if "dist-packages" in p][-1]) \
PY
); \
    LOCAL_SITE=$(/usr/local/python/current/bin/python3 - <<'PY' \
import site; \
print([p for p in site.getsitepackages() if "dist-packages" in p][-1]) \
PY
); \
    echo "Copying catkin_pkg from ${SYS_SITE} to ${LOCAL_SITE}"; \
    mkdir -p "${LOCAL_SITE}"; \
    cp -r "${SYS_SITE}/catkin_pkg" "${LOCAL_SITE}/"; \
    if compgen -G "${SYS_SITE}/catkin_pkg"*info >/dev/null; then \
      cp -r ${SYS_SITE}/catkin_pkg*info "${LOCAL_SITE}/"; \
    fi

# Ensure ros user can access ROS setup file
RUN chmod +rx /opt/ros/${ROS_DISTRO}/setup.bash

# Setup sudo: gives the user specified by USERNAME passwordless sudo
RUN echo ${USERNAME} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME}

# Preserve upstream entrypoint for VNC/noVNC startup
RUN mv /entrypoint.sh /entrypoint_base.sh

COPY entrypoint_ros2_control.sh /ros_entrypoint.sh
COPY bashrc /home/$USERNAME/.bashrc

RUN chmod +x /ros_entrypoint.sh /entrypoint_base.sh && \
    chown $USERNAME:$GROUP_ID /home/$USERNAME/.bashrc && \
    mkdir -p /home/$USERNAME/ros2_ws/src && \
    chown -R $USERNAME:$GROUP_ID /home/$USERNAME/ros2_ws

WORKDIR /home/$USERNAME/ros2_ws/src

ENTRYPOINT ["/ros_entrypoint.sh"]

CMD ["bash"]
