services:
  ros2-jazzy-xfce:
    build:
      context: .
      args:
        INSTALL_PACKAGE: desktop # or 'ros-base' for leaner
    image: ros2-jazzy-xfce-vnc
    container_name: ros2-jazzy-xfce
    environment:
      USER: ubuntu
      PASSWORD: change-me
      VNC_GEOMETRY: 1600x900
      VNC_DEPTH: "24"
      VNC_PORT: "5901"
      NO_VNC_PORT: "6080"
      # ---- Stability helpers for Gazebo/RViz over VNC ----
      QT_X11_NO_MITSHM: "1"
      LIBGL_DRI3_DISABLE: "1"
      # LIBGL_ALWAYS_SOFTWARE: "1"   # enable only as last resort; slower but very stable
      RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
      ROS_DOMAIN_ID: "7"
      ROS_AUTOMATIC_DISCOVERY_RANGE: LOCALHOST
    ports:
      - "8080:6080" # noVNC in browser; remove if you don't use noVNC
      - "5901:5901" # VNC client
    volumes:
      - ./ros2_ws:/home/ubuntu/ros2_ws
    shm_size: "2gb"
    tty: true
